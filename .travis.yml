language: cpp

compiler:
  - gcc

addons:
  hosts:
    - 127.0.0.1.xip.io
    - alternate.127.0.0.1.xip.io

before_install:
  # upgrade g++ and libstdc++ to build nghttp2
  - sudo add-apt-repository --yes ppa:ubuntu-toolchain-r/test
  - sudo apt-add-repository --yes ppa:smspillaz/cmake-2.8.12
  - sudo apt-get --yes update
  - sudo apt-get install --yes cmake cmake-data g++-4.8 libstdc++-4.8-dev php5-cgi wget
  - if [ "$CXX" = "g++" ]; then export CXX="g++-4.8"; fi
  - $CXX --version
  # for speed, pre-install deps installed in `before_script` section as ubuntu packages
  - sudo apt-get install -qq cpanminus libipc-signal-perl liblist-moreutils-perl libwww-perl libio-socket-ssl-perl zlib1g-dev dnsutils

before_script:
  - dig search.cpan.org
  - misc/install-perl-module.pl Net::EmptyPort || sudo strace -e select,connect,recvfrom,sendto,read  -f -s 128 misc/install-perl-module.pl Net::EmptyPort
  - misc/install-perl-module.pl Scope::Guard || sudo strace -e select,connect,recvfrom,sendto,read  -f -s 128 misc/install-perl-module.pl Scope::Guard
  - misc/install-perl-module.pl Plack || sudo strace -e select,connect,recvfrom,sendto,read  -f -s 128 misc/install-perl-module.pl Plack
  - misc/install-perl-module.pl FCGI || sudo strace -e select,connect,recvfrom,sendto,read  -f -s 128 misc/install-perl-module.pl FCGI
  - misc/install-perl-module.pl http://search.cpan.org/CPAN/authors/id/A/AR/ARODLAND/FCGI-ProcManager-0.25.tar.gz
  - misc/install-perl-module.pl Starlet || sudo strace -e select,connect,recvfrom,sendto,read  -f -s 128 misc/install-perl-module.pl Starlet
  - misc/install-perl-module.pl JSON
  - misc/install-perl-module.pl Path::Tiny
  - misc/install-perl-module.pl Test::Exception

script:
  - true
